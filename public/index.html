<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Chatbot ThiÃªn Kim â€” Giá»ng Ban Mai</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--primary:#f06b9a;--muted:#666;}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
body{
  background:linear-gradient(180deg,#f4f6f8 0%,#eef2f6 100%);
  display:flex;align-items:center;justify-content:center;padding:28px;
}
.card{
  width:460px;max-width:96%;background:#fff;border-radius:14px;
  box-shadow:0 12px 40px rgba(14,18,30,0.08);padding:18px;text-align:center;
}
h1{margin:6px 0;color:var(--primary);font-size:20px}
p.lead{margin:6px 0 12px;color:var(--muted);font-size:14px}
.avatar-frame{width:300px;height:300px;border-radius:18px;overflow:hidden;
  margin:12px auto;position:relative;background-size:cover;background-position:center;}
.avatar-frame.with-img{background-image:url('/office_bg.jpg');}
.avatar-wrapper{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
.avatar{width:92%;height:92%;object-fit:cover;border-radius:10px;}
.nameplate{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);
  background:rgba(0,0,0,0.65);color:#fff;padding:6px 12px;border-radius:999px;
  font-weight:600;font-size:15px;}
.controls{display:flex;gap:8px;justify-content:center;margin-top:10px;}
button{background:var(--primary);color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer;}
.secondary{background:#7a8a98;}
.status{margin-top:10px;color:var(--muted);font-size:13px;}
.log{margin-top:12px;text-align:left;background:#fafafa;border-radius:8px;
  padding:10px;max-height:160px;overflow:auto;font-size:14px;}
</style>
</head>

<body>
  <div class="card">
    <h1>Chatbot HR â€” ThiÃªn Kim ğŸ’¼</h1>
    <p class="lead">Phá»ng váº¥n nhÃ¢n sá»± â€” Giá»ng Ban Mai (FPT.AI)</p>

    <div class="avatar-frame with-img">
      <div class="avatar-wrapper">
        <img src="/avatar_hr.png" class="avatar" alt="ThiÃªn Kim" />
        <div class="nameplate">ThiÃªn Kim â€” NhÃ¢n sá»±</div>
      </div>
    </div>

    <div class="controls">
      <button id="startBtn">ğŸ™ï¸ Báº¯t Ä‘áº§u phá»ng váº¥n</button>
      <button id="stopBtn" class="secondary">â¹ Dá»«ng</button>
    </div>

    <div class="status" id="statusText">Nháº¥n "Báº¯t Ä‘áº§u phá»ng váº¥n" Ä‘á»ƒ khá»Ÿi Ä‘á»™ng.</div>
    <div class="log" id="chatLog" aria-live="polite"></div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

// ğŸ’¬ Danh sÃ¡ch cÃ¢u há»i
const QUESTIONS = [
  "Xin chÃ o, tÃ´i lÃ  ThiÃªn Kim phá»¥ trÃ¡ch nhÃ¢n sá»±. Ráº¥t vui Ä‘Æ°á»£c gáº·p báº¡n!",
  "Báº¡n cÃ³ biáº¿t hÃ´m nay lÃ  thá»© máº¥y khÃ´ng?",
  "Theo báº¡n, buá»•i sÃ¡ng nÃªn lÃ m gÃ¬ Ä‘áº§u tiÃªn?",
  "Báº¡n cÃ³ thá»ƒ giáº£i thÃ­ch Ã½ nghÄ©a cá»§a 'tÃ´n trá»ng' trong giao tiáº¿p khÃ´ng?",
  "Theo báº¡n, tha thá»© cÃ³ khÃ³ khÃ´ng?",
  "Báº¡n nÃªn nÃ³i gÃ¬ khi ai Ä‘Ã³ Ä‘ang buá»“n?",
  "Báº¡n thÃ­ch thÃº cÆ°ng khÃ´ng?",
  "Con váº­t nÃ o dá»… nuÃ´i nháº¥t theo báº¡n?",
  "ChÃ o táº¡m biá»‡t báº¡n vÃ  háº¹n gáº·p láº¡i!"
];

let current = 0, recognition = null, isRunning = false, retrying = false;
const statusEl = document.getElementById('statusText');
const chatLog = document.getElementById('chatLog');

function appendLog(who,text){
  const d=document.createElement('div');
  d.innerHTML=`<strong>${who}:</strong> ${text}`;
  chatLog.appendChild(d);
  chatLog.scrollTop=chatLog.scrollHeight;
}
function setStatus(t){statusEl.textContent=t;}

/* ==== TTS ==== */
async function speakServer(msg){
  try{
    const r=await fetch('/api/tts',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:msg})
    });
    if(r.ok){
      const b=await r.blob();
      const url=URL.createObjectURL(b);
      const audio=new Audio(url);
      await audio.play().catch(()=>setStatus("ğŸ”‡ Báº­t tiáº¿ng nhÃ©!"));
      return new Promise(res=>audio.onended=res);
    }
  }catch(e){console.error("ğŸ’¥ TTS error:",e);}
}

/* ==== GPT ==== */
async function getGPTReply(userInput){
  try{
    const r=await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:userInput})
    });
    const j=await r.json();
    return j.reply||"Cáº£m Æ¡n báº¡n nhÃ©!";
  }catch(e){return"Xin lá»—i, máº¡ng cháº­m rá»“i.";}
}

/* ==== SPEECH RECOGNITION ==== */
function initRecognition(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert("TrÃ¬nh duyá»‡t nÃ y khÃ´ng há»— trá»£ voice nhÃ©.");return null;}
  const r=new SR();
  r.lang='vi-VN';r.interimResults=false;r.maxAlternatives=1;

  r.onstart=()=>setStatus("ğŸ¤ Äang nghe báº¡n...");

  r.onerror=async e=>{
    if(!isRunning)return;
    if(e.error==="no-speech"||e.error==="audio-capture"){
      appendLog("ThiÃªn Kim","Xin lá»—i, mÃ¬nh chÆ°a nghe rÃµ, báº¡n nÃ³i láº¡i nhÃ©.");
      await speakServer("Xin lá»—i, mÃ¬nh chÆ°a nghe rÃµ, báº¡n nÃ³i láº¡i nhÃ©.");
      retrying=true;
      recognition.start(); // ğŸ” má»Ÿ láº¡i mic
    }else{
      setStatus("âš ï¸ Lá»—i mic, thá»­ láº¡i sau.");console.error("Mic error:",e);
    }
  };

  r.onend=()=>{
    if(isRunning&&!retrying){
      setTimeout(()=>{
        if(isRunning){
          appendLog("ThiÃªn Kim","Báº¡n cÃ³ thá»ƒ nÃ³i láº¡i khÃ´ng?");
          speakServer("Báº¡n cÃ³ thá»ƒ nÃ³i láº¡i khÃ´ng?");
          recognition.start();
        }
      },1200);
    }
  };

  r.onresult=async e=>{
    retrying=false;
    const userText=e.results[0][0].transcript.trim();
    appendLog("Báº¡n",userText);
    setStatus("ğŸ§  Äang pháº£n há»“i...");
    const reply=await getGPTReply(userText);
    appendLog("ThiÃªn Kim",reply);
    await speakServer(reply);

    current++;
    if(current<QUESTIONS.length){
      appendLog("ThiÃªn Kim",QUESTIONS[current]);
      await speakServer(QUESTIONS[current]);
      recognition.start(); // nghe cÃ¢u tiáº¿p
    }else{
      setStatus("âœ… Káº¿t thÃºc phá»ng váº¥n.");
      isRunning=false;
    }
  };
  return r;
}

/* ==== Báº®T Äáº¦U ==== */
document.getElementById('startBtn').onclick=async()=>{
  if(isRunning)return;
  isRunning=true;current=0;chatLog.innerHTML="";
  recognition=initRecognition();
  appendLog("ThiÃªn Kim",QUESTIONS[current]);
  await speakServer(QUESTIONS[current]);
  recognition.start();
};

/* ==== Dá»ªNG ==== */
document.getElementById('stopBtn').onclick=()=>{
  if(recognition)recognition.stop();
  isRunning=false;
  setStatus("â¹ ÄÃ£ dá»«ng.");
};

});
</script>
</body>
</html>
