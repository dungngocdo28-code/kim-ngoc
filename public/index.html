<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Chatbot Thi√™n Kim ‚Äî Ph·ªèng v·∫•n (Gi·ªçng Ban Mai)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --primary:#f06b9a; --muted:#666; }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  body{background:linear-gradient(180deg,#f4f6f8 0%,#eef2f6 100%);
       display:flex;align-items:center;justify-content:center;padding:28px;}
  .card{width:460px;max-width:96%;background:#fff;border-radius:14px;
        box-shadow:0 12px 40px rgba(14,18,30,0.08);padding:18px;text-align:center;}
  h1{margin:6px 0;color:var(--primary);font-size:20px;}
  p.lead{margin:6px 0 12px;color:var(--muted);font-size:14px;}
  .avatar-frame{width:300px;height:300px;border-radius:18px;overflow:hidden;
        margin:12px auto;position:relative;background-size:cover;background-position:center;
        background-image:url('/office_bg.jpg');transition:transform 0.25s ease;}
  .avatar-wrapper{position:relative;width:100%;height:100%;display:flex;
        align-items:center;justify-content:center;z-index:2;}
  .avatar{width:92%;height:92%;object-fit:cover;border-radius:10px;
        transition:transform 0.12s ease,filter 0.12s ease;}
  .avatar-wrapper.smile .avatar{transform:scale(1.02) translateY(-3px);filter:brightness(1.05);}
  .nameplate{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);
        background:rgba(0,0,0,0.65);color:#fff;padding:6px 12px;border-radius:999px;
        font-weight:600;font-size:15px;z-index:3;}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:10px;}
  button{background:var(--primary);color:#fff;border:0;border-radius:8px;
         padding:10px 14px;cursor:pointer;}
  button[disabled]{opacity:0.6;cursor:not-allowed;}
  .secondary{background:#7a8a98;padding:10px 12px;}
  .status{margin-top:10px;color:var(--muted);font-size:13px;}
  .log{margin-top:12px;text-align:left;background:#fafafa;border-radius:8px;
       padding:10px;max-height:160px;overflow:auto;font-size:14px;}
  .log div{margin-bottom:8px;}
  .log strong{color:#222;margin-right:6px;}
</style>
</head>

<body onclick="try{new Audio().play().catch(()=>{})}catch(e){}">
  <div class="card">
    <h1>Chatbot HR ‚Äî Thi√™n Kim üíº</h1>
    <p class="lead">Ph·ªèng v·∫•n nh√¢n s·ª± ‚Äî ti·∫øng Vi·ªát (Gi·ªçng Ban Mai)</p>

    <div class="avatar-frame">
      <div class="avatar-wrapper" id="avatarWrap">
        <img id="avatar" class="avatar" src="/avatar_hr.png" alt="Thi√™n Kim" />
        <div class="nameplate">Thi√™n Kim ‚Äî Nh√¢n s·ª±</div>
      </div>
    </div>

    <div class="controls">
      <button id="startBtn">üéôÔ∏è B·∫Øt ƒë·∫ßu ph·ªèng v·∫•n</button>
      <button id="stopBtn" disabled class="secondary">‚èπ D·ª´ng</button>
    </div>

    <div class="status" id="statusText">Nh·∫•n "B·∫Øt ƒë·∫ßu ph·ªèng v·∫•n" ƒë·ªÉ kh·ªüi ƒë·ªông.</div>
    <div class="log" id="chatLog" aria-live="polite"></div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

// üßæ Danh s√°ch c√¢u h·ªèi
const QUESTIONS = [
  "Xin ch√†o, t√¥i l√† Thi√™n Kim ph·ª• tr√°ch nh√¢n s·ª±. R·∫•t vui ƒë∆∞·ª£c g·∫∑p b·∫°n!",
  "B·∫°n c√≥ bi·∫øt h√¥m nay l√† th·ª© m·∫•y kh√¥ng?",
  "Theo b·∫°n, bu·ªïi s√°ng n√™n l√†m g√¨ ƒë·∫ßu ti√™n?",
  "B·∫°n c√≥ th·ªÉ gi·∫£i th√≠ch √Ω nghƒ©a c·ªßa 't√¥n tr·ªçng' trong giao ti·∫øp kh√¥ng?",
  "Theo b·∫°n, tha th·ª© c√≥ kh√≥ kh√¥ng?",
  "B·∫°n n√™n n√≥i g√¨ khi ai ƒë√≥ ƒëang bu·ªìn?",
  "B·∫°n th√≠ch th√∫ c∆∞ng kh√¥ng?",
  "Con v·∫≠t n√†o d·ªÖ nu√¥i nh·∫•t theo b·∫°n?",
  "Ch√†o t·∫°m bi·ªát b·∫°n v√† h·∫πn g·∫∑p l·∫°i!"
];

let current = 0, recognition = null, isRunning = false, noSpeechCount = 0;

const statusEl = document.getElementById('statusText');
const chatLog = document.getElementById('chatLog');
const avatarWrap = document.getElementById('avatarWrap');

function appendLog(who, text){
  const d=document.createElement('div');
  d.innerHTML=`<strong>${who}:</strong> ${text}`;
  chatLog.appendChild(d);
  chatLog.scrollTop=chatLog.scrollHeight;
}
function setStatus(t){ statusEl.textContent=t; }

/* ==== TTS ==== */
async function speakServer(msg, resumeMic = true){
  try{
    if(recognition && isRunning) recognition.stop(); // ‚õî t·∫Øt mic khi bot n√≥i
    const r=await fetch('/api/tts',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:msg})
    });
    if(r.ok){
      const b=await r.blob();
      const url=URL.createObjectURL(b);
      const audio=new Audio(url);
      avatarWrap.classList.add('smile');
      await audio.play().catch(()=>setStatus("üîá H√£y b·∫≠t ti·∫øng!"));
      return new Promise(res=>{
        audio.onended=()=>{
          avatarWrap.classList.remove('smile');
          URL.revokeObjectURL(url);
          if(isRunning && recognition && resumeMic){
            setTimeout(()=>{
              recognition.start();
              setStatus("üé§ ƒêang nghe b·∫°n...");
            },600);
          }
          res();
        };
      });
    }
  }catch(e){console.error("üí• TTS error:",e);}
}

/* ==== GPT ==== */
async function getGPTReply(userInput){
  try{
    const r=await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:userInput})
    });
    const j=await r.json();
    return j.reply||'C·∫£m ∆°n b·∫°n nh√©!';
  }catch(e){return "Xin l·ªói, m·∫°ng h∆°i ch·∫≠m r·ªìi.";}
}

/* ==== SPEECH ==== */
function initRecognition(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ voice. D√πng Chrome nh√©!");return null;}
  const r=new SR();
  r.lang='vi-VN';r.interimResults=false;r.maxAlternatives=1;
  r.onstart=()=>setStatus("üé§ ƒêang nghe b·∫°n...");

  // ‚ö†Ô∏è Kh√¥ng nghe r√µ
  r.onerror=async e=>{
    if(!isRunning)return;
    if(["no-speech","audio-capture","network"].includes(e.error)){
      noSpeechCount++;
      if(noSpeechCount>=3){
        appendLog("Thi√™n Kim","C√≥ v·∫ª ƒë∆∞·ªùng truy·ªÅn ch∆∞a ·ªïn. M√¨nh xin ph√©p k·∫øt th√∫c bu·ªïi tr√≤ chuy·ªán nh√©.");
        await speakServer("C√≥ v·∫ª ƒë∆∞·ªùng truy·ªÅn ch∆∞a ·ªïn. M√¨nh xin ph√©p k·∫øt th√∫c bu·ªïi tr√≤ chuy·ªán nh√©.", false);
        setStatus("üõë ƒê√£ k·∫øt th√∫c v√¨ kh√¥ng nghe r√µ.");
        isRunning=false;
        recognition.stop();
        return;
      }
      appendLog("Thi√™n Kim","Xin l·ªói, m√¨nh ch∆∞a nghe r√µ, b·∫°n n√≥i l·∫°i nh√©.");
      await speakServer("Xin l·ªói, m√¨nh ch∆∞a nghe r√µ, b·∫°n n√≥i l·∫°i nh√©.");
    }
  };

  // ‚úÖ Khi c√≥ k·∫øt qu·∫£
  r.onresult=async e=>{
    noSpeechCount=0;
    const userText=e.results[0][0].transcript.trim();
    appendLog("B·∫°n",userText);
    setStatus("üß† ƒêang ph·∫£n h·ªìi...");

    const reply=await getGPTReply(userText);
    appendLog("Thi√™n Kim",reply);
    await speakServer(reply,false);

    current++;
    if(current<QUESTIONS.length){
      appendLog("Thi√™n Kim",QUESTIONS[current]);
      await speakServer(QUESTIONS[current]);
    }else{
      appendLog("Thi√™n Kim","C·∫£m ∆°n b·∫°n, bu·ªïi tr√≤ chuy·ªán th·∫≠t tuy·ªát! H·∫πn g·∫∑p l·∫°i nh√©.");
      await speakServer("C·∫£m ∆°n b·∫°n, bu·ªïi tr√≤ chuy·ªán th·∫≠t tuy·ªát! H·∫πn g·∫∑p l·∫°i nh√©.", false);
      setStatus("‚úÖ K·∫øt th√∫c ph·ªèng v·∫•n.");
      isRunning=false;
    }
  };

  // üîÅ Khi mic t·ª± d·ª´ng m√† kh√¥ng c√≥ √¢m thanh
  r.onend=()=>{
    if(isRunning && noSpeechCount<3){
      setTimeout(()=>{
        if(isRunning){
          appendLog("Thi√™n Kim","M√¨nh ch∆∞a nghe th·∫•y b·∫°n n√≥i g√¨, b·∫°n c√≥ th·ªÉ n√≥i l·∫°i kh√¥ng?");
          speakServer("M√¨nh ch∆∞a nghe th·∫•y b·∫°n n√≥i g√¨, b·∫°n c√≥ th·ªÉ n√≥i l·∫°i kh√¥ng?");
        }
      },1000);
    }
  };
  return r;
}

/* ==== START ==== */
document.getElementById('startBtn').onclick=async()=>{
  if(isRunning)return;
  isRunning=true;current=0;noSpeechCount=0;chatLog.innerHTML="";
  recognition=initRecognition();
  appendLog("Thi√™n Kim",QUESTIONS[current]);
  await speakServer(QUESTIONS[current]);
};

/* ==== STOP ==== */
document.getElementById('stopBtn').onclick=()=>{
  if(recognition)recognition.stop();
  isRunning=false;
  setStatus("‚èπ ƒê√£ d·ª´ng.");
};

});
</script>
</body>
</html>
